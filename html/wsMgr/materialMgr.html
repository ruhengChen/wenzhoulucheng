<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>三门峡黄河公铁两用桥信息系统</title>
    <link rel="stylesheet" href="../../bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href='../../plugins/zTree/css/blueStyle/blueStyle.css'>
    <link rel="stylesheet" href="../../plugins/daterangepicker/daterangepicker.css">
    <link rel="stylesheet" href="../../plugins/jquery/alert/css/xcConfirm.css">
    <link rel="stylesheet" href="../../css/base.css">
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/userMgr.css">
    <link rel="stylesheet" href="../../plugins/toastr/toastr.min.css">
    <style>
        .tab-container{
            height: 100%;
        }
        .tab-pane{
            height: 100%;
        }
        .container{
            padding-left: 15px;
        }
        .mainContent{
            padding-left: 0;
        }
        .childSidebar{
            top:187px;
            left:15px;
        }
        .childContainer{
            padding-left: 232px;
            overflow: auto;
        }
        .table-container{
            height:calc(100% - 55px);
        }
        .table-container3{
            height:calc(100% - 125px);
            overflow: auto;
        }
        #materialTable{
            overflow: auto;
        }
        .tableToolBar>.editPlanMaterial{
            width: 105px;
        }

    </style>
</head>
<body>
<header class="ysh-smxHead">
    <div class="ysh-smxTitle">
        <img class="smxLogo" src="../../images/home/logo.png" alt="">
        <h5>三门峡黄河公铁两用桥信息系统</h5>
    </div>


    <ul id="loginOk" class="ysh-XTList">
        <li><a href="javascript:;">退出系统</a></li>
        <li><a href="javascript:;">消息<span class="xtInfo"></span></a></li>
        <li><span class="xiUser"></span>，欢迎使用本系统！</li>
    </ul>
</header>
<div class="ysh-menu">
    <ul class="ysh-menuList">
        <li><a href="../main.html">首页</a></li>
        <li><a  href="../itemGK/itemIntro.html">工程概况</a></li>
        <li><a  href="../userMgr.html">人员管理</a></li>

        <li class="wsMgr">
            <a style=" background: rgb(0,133,106);" href="javascript:;">物设管理</a>
            <ul class="wsCont ysh-disappear">
                <li><a href="equipment.html">机械设备</a></li>
                <li><a href="materialMgr.html">材料设备</a></li>
            </ul>
        </li>
        <li>
            <a href="javascript:;">进度管理</a>
            <ul class="jdCont ysh-disappear">
                <li><a href="../processMgr/itemUnit.html">项目单位</a></li>
                <li><a href="../processMgr/sgPlan.html">总施工进度</a></li>
            </ul>
        </li>
        <li>
            <a href="../safeMgr/safeUserMgr.html">安全管理</a>
        </li>
        <li>
            <a  href="javascript:;">质量管理</a>
            <ul class="zlCont ysh-disappear">
                <li><a class="reportMgr" href="../zlMgr/reportMgr.html">检测报告</a></li>
            </ul>
        </li>
        <li><a href="javascript:;">风险管理</a></li>
        <li><a href="../jsMgr/datumMgr.html">技术管理</a></li>
        <li><a href="javascript:;">试验管理</a></li>
        <li><a href="javascript:;">视频监控</a></li>
        <li class="sysMgr">
            <a href="javascript:;">系统管理</a>
            <ul class="sysCont ysh-disappear">
                <li><a class="attrMgr" href="../sysMgr/attrMgr.html">属性管理</a></li>
                <li><a class="attrMgr" href="../sysMgr/materialTypeMgr.html">材料类型</a></li>
            </ul>
        </li>
    </ul>
</div>
<div class="container">
    <!--<div class="sidebar">-->
        <!--<ul id="materialTreeUnit" class="ztree"></ul>-->
    <!--</div>-->
    <div class="mainContent">
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active"><a href="#actuallyCL" aria-controls="home" role="tab" data-toggle="tab">材料总量</a></li>
            <li role="presentation"><a href="#planCL" aria-controls="profile" role="tab" data-toggle="tab">计划材料</a></li>
            <li role="presentation"><a href="#useCl" aria-controls="profile" role="tab" data-toggle="tab">领料详情</a></li>
        </ul>
        <!-- Tab panes -->
        <div class="tab-content tab-container">
            <div role="tabpanel" class="tab-pane active" id="actuallyCL">
                <!--<div class="tableToolBar tableTitle">项目名称</div>-->
                <!--<table id="ysh-unitTable"></table>-->
                <div class="table-container">
                <table id="materialALLTable" class="table table-striped planTable">
                <thead>
                <tr>
                <th>序号</th>
                <th>材料名称</th>
                <!--<th>型号</th>-->
                <th>规格</th>
                <th>总进料</th>
                <th>总用料</th>
                <!--<th>单位</th>-->
                <th>库存</th>
                <th>操作</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                <td colspan="9">请选择项目</td>
                </tr>

                </tbody>
                </table>
                </div>
                <div class="tableToolBar">
                    <span class="addUser jlMaterial"><b></b>进料</span>
                    <!--<span class="editUser ylMaterial"><b></b>领料</span>-->
                    <!--<span class="delUser delMaterial"><b></b>删除</span>-->
                    <!--<span class="seeUser"><b></b>导出</span>-->
                    <!--<button class="btn btn-default addUser">增加</button>-->
                    <!--<button class="btn btn-default editUser">修改</button>-->
                    <!--<button class="btn btn-default delUser">删除</button>-->
                    <!--<button class="btn btn-default seeUser">查看</button>-->
                </div>
            </div>
            <div role="tabpanel" class="tab-pane" id="planCL">
                <!--<div class="tableToolBar tableTitle">项目名称</div>-->
                <!--<table id="ysh-unitTable"></table>-->
                <div class="table-container">
                    <table id="materialPlanTable" class="table table-striped planTable">
                        <thead>
                        <tr>
                            <th>序号</th>
                            <th>材料名称</th>
                            <!--<th>型号</th>-->
                            <th>规格</th>
                            <th>总进料</th>
                            <th>计划用料</th>
                            <!--<th>单位</th>-->
                            <!--<th>库存</th>-->
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td colspan="8">请选择项目</td>
                        </tr>

                        </tbody>
                    </table>
                </div>
                <div class="tableToolBar">
                    <span class="addUser editPlanMaterial"><b></b>修改计划用料</span>
                    <!--<span class="editUser ylMaterial"><b></b>领料</span>>-->
                </div>
            </div>
            <div role="tabpanel" class="tab-pane " id="useCl">
                <div class="sidebar childSidebar">
                <ul id="materialTreeUnit" class="ztree"></ul>
                </div>
                <div class="mainContent childContainer">
                    <div class="tableToolBar tableTitle">项目名称</div>
                    <!--<table id="ysh-unitTable"></table>-->
                    <div class="table-container3">
                        <table id="materialTable" class="table table-striped planTable">
                            <thead>
                            <tr>
                                <th>序号</th>
                                <th>材料名称</th>
                                <!--<th>型号</th>-->
                                <th>规格</th>
                                <!--<th>总进料</th>-->
                                <th>总用料</th>
                                <!--<th>单位</th>-->
                                <th>库存</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td colspan="9">请选择项目</td>
                            </tr>

                            </tbody>
                        </table>
                    </div>
                    <div class="tableToolBar">
                        <!--<span class="addUser jlMaterial"><b></b>进料</span>-->
                        <span class="editUser ylMaterial"><b></b>领料</span>
                        <!--<span class="delUser delMaterial"><b></b>删除</span>-->
                        <!--<span class="seeUser"><b></b>导出</span>-->
                        <!--<button class="btn btn-default addUser">增加</button>-->
                        <!--<button class="btn btn-default editUser">修改</button>-->
                        <!--<button class="btn btn-default delUser">删除</button>-->
                        <!--<button class="btn btn-default seeUser">查看</button>-->
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>
<!--材料增加修改模态框-->
<div class="modal fade" id="materialModal" tabindex="-1" role="dialog"  aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="materialModalLabel"></h4>
            </div>
            <div class="modal-body" style="height: 400px;overflow-x: hidden;overflow-y: auto">
                <form class="form-horizontal">
                    <div class="form-group">
                        <label for="materialName" class="col-sm-3 control-label">材料名称</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="materialName" :duplex="@material_Info.NAME">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="materialNo" class="col-sm-3 control-label">型号</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="materialNo" :duplex="@material_Info.NO">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="materialScale" class="col-sm-3 control-label">规格</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="materialScale" :duplex="@material_Info.UNO">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="materialNum" class="col-sm-3 control-label">总进料</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="materialNum" :duplex="@material_Info.materialNum">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="materialUseSum" class="col-sm-3 control-label">总用料</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="materialUseSum" :duplex="@material_Info.materialUseNum">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="materialDw" class="col-sm-3 control-label">单位</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="materialDw" :duplex="@material_Info.materialDw">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" :click="subSgModal">确定</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<!--用料料明细-->
<div id="materialUseData" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"  aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" >领料明细</h4>
            </div>
            <div class="modal-body" style="height: 400px;overflow-x: hidden;overflow-y: auto">
                <div id="Use-toolbar">
                    <button class="btn btn-default addUseMaterial">增加</button>
                    <button class="btn btn-default editUseMaterial">修改</button>
                    <button class="btn btn-default delUseMaterial">删除</button>
                    <!--<button class="btn btn-default seeUseMaterial">查看</button>-->
                </div>
                <!--<table id="eventTable"></table>-->
                <div class="table-container">
                    <table data-buid="" data-mid="" data-MName="" id="materialUseTable"
                           class="table table-striped planTable">
                        <thead>
                        <tr>
                            <th>序号</th>
                            <th>材料名称</th>
                            <th>日期</th>
                            <th>数量</th>
                            <th>领料人</th>
                            <th>部门</th>
                            <th>备注</th>
                            <!--<th>单位</th>-->
                            <!--<th>库存</th>-->
                            <!--<th>操作</th>-->
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td colspan="7">正在加载，请稍候...</td>
                        </tr>
                        <!--<tr>-->
                        <!--<td>2</td>-->
                        <!--<td>钢筋</td>-->
                        <!--<td>G-1</td>-->
                        <!--<td>直径1CM</td>-->
                        <!--<td>8</td>-->
                        <!--<td>6</td>-->
                        <!--<td>吨</td>-->
                        <!--<td>2</td>-->
                        <!--<td></td>-->
                        <!--</tr>-->

                        </tbody>
                    </table>
                </div>


            </div>
        </div>
    </div>
</div>
<!--进料料明细-->
<div id="materialInData" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"  aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="">进料明细</h4>
            </div>
            <div class="modal-body" style="height: 400px;overflow-x: hidden;overflow-y: auto">
                <div id="In-toolbar">
                    <button class="btn btn-default addInMaterial">增加</button>
                    <button class="btn btn-default editInMaterial">修改</button>
                    <button class="btn btn-default delInMaterial">删除</button>
                    <!--<button class="btn btn-default seeInMaterial">查看</button>-->
                </div>
                <!--<table id="eventTable"></table>-->
                <div class="table-container">
                    <table id="materialInTable" data-MName="" data-buid="" data-mid="" class="table table-striped planTable">
                        <thead>
                        <tr>
                            <th>序号</th>
                            <th>材料名称</th>
                            <th>日期</th>
                            <th>数量</th>
                            <th>运输工具</th>
                            <th>负责人</th>
                            <th>备注</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td colspan="7">正在加载，请稍候...</td>
                        </tr>
                        <!--<tr>-->
                        <!--<td>2</td>-->
                        <!--<td>钢筋</td>-->
                        <!--<td>G-1</td>-->
                        <!--<td>直径1CM</td>-->
                        <!--<td>8</td>-->
                        <!--<td>6</td>-->
                        <!--<td>吨</td>-->
                        <!--<td>2</td>-->
                        <!--<td></td>-->
                        <!--</tr>-->

                        </tbody>
                    </table>
                </div>


            </div>
        </div>
    </div>
</div>
<!--材料用料增加修改模态框-->
<div class="modal fade" id="materialUseModal" tabindex="-1" role="dialog"  aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="materialUseModalLabel"></h4>
            </div>
            <div class="modal-body" style="height: 400px;overflow-x: hidden;overflow-y: auto">
                <form class="form-horizontal useMaterialForm" data-buid="" data-mId="" data-MName="">
                    <!--<div class="form-group">-->
                    <!--<label for="materialUseName" class="col-sm-3 control-label">材料名称</label>-->
                    <!--<div class="col-sm-9">-->
                    <!--<input type="text" class="form-control" id="materialUseName">-->
                    <!--</div>-->
                    <!--</div>-->
                    <div class="form-group">
                        <label for="materialNo" class="col-sm-3 control-label">日期</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control " id="materialUseDate" >
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="materialUseNum" class="col-sm-3 control-label">数量</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="materialUseNum" >
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="materialDw" class="col-sm-3 control-label">领料人</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="materialUseManager">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="departId" class="col-sm-3 control-label">领料部门</label>
                        <div class="col-sm-9">
                            <select name="" id="departId" class="form-control"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="materialDw" class="col-sm-3 control-label">备注</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="materialUseRMK" >
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="subMaterialUse">确定</button>
                <button type="button" class="btn btn-primary" id="subEditMaterialUse">确定</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<!--材料进料增加修改模态框-->
<div class="modal fade" id="materialInModal" tabindex="-1" role="dialog"  aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="materialInModalLabel"></h4>
            </div>
            <div class="modal-body" style="height: 400px;overflow-x: hidden;overflow-y: auto">
                <form class="form-horizontal inMaterialForm" data-buid="" data-mid="" data-MName="">
                    <!--<div class="form-group">-->
                    <!--<label for="materialInName" class="col-sm-3 control-label">材料名称</label>-->
                    <!--<div class="col-sm-9">-->
                    <!--<input type="text" class="form-control" id="materialInName">-->

                    <!--&lt;!&ndash;<select name="" id="materialInName" class="form-control">&ndash;&gt;-->

                    <!--&lt;!&ndash;</select>&ndash;&gt;-->
                    <!--&lt;!&ndash;<input type="text" class="form-control" id="materialName" :duplex="@material_Info.NAME">&ndash;&gt;-->
                    <!--</div>-->
                    <!--</div>-->
                    <div class="form-group">
                        <label for="materialNo" class="col-sm-3 control-label">日期</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="materialInDate">
                            <!--<input type="text" class="form-control" id="materialInDate" :duplex="@material_Info.NO">-->
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="materialScale" class="col-sm-3 control-label">数量</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="materialInSum">
                            <!--<input type="text" class="form-control" id="materialInSum" :duplex="@material_Info.UNO">-->
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="materialInTool" class="col-sm-3 control-label">运输工具</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="materialInTool">
                            <!--<select name="" id="materialInTool" class="form-control">-->

                            <!--</select>-->
                            <!--<input type="text" class="form-control" id="materialInTool" :duplex="@material_Info.materialDw">-->
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="materialInManager" class="col-sm-3 control-label">负责人</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="materialInManager" >
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="materialInRMK" class="col-sm-3 control-label">备注</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="materialInRMK" >
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="subMaterialIn">确定</button>
                <button type="button" class="btn btn-primary" id="subEditMaterialIn">确定</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<!--材料计划用料增加修改模态框-->
<div class="modal fade" id="materialPlanUseModal" data-mid="" tabindex="-1" role="dialog"  aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="materialPlanUseModalLabel"></h4>
            </div>
            <div class="modal-body" style="height: 200px;overflow-x: hidden;overflow-y: auto">
                <form class="form-horizontal useMaterialForm" data-buid="" data-mid="" data-MName="">
                    <!--<div class="form-group">-->
                    <!--<label for="materialUseName" class="col-sm-3 control-label">材料名称</label>-->
                    <!--<div class="col-sm-9">-->
                    <!--<input type="text" class="form-control" id="materialUseName">-->
                    <!--</div>-->
                    <!--</div>-->
                    <!--<div class="form-group">-->
                        <!--<label for="materialNo" class="col-sm-3 control-label">日期</label>-->
                        <!--<div class="col-sm-9">-->
                            <!--<input type="text" class="form-control " id="materialPlanUseDate" >-->
                        <!--</div>-->
                    <!--</div>-->
                    <div class="form-group">
                        <label for="materialUseNum" class="col-sm-3 control-label">计划用料</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="materialPlanUseNum" >
                        </div>
                    </div>
                    <!--<div class="form-group">-->
                        <!--<label for="materialDw" class="col-sm-3 control-label">领料人</label>-->
                        <!--<div class="col-sm-9">-->
                            <!--<input type="text" class="form-control" id="materialPlanUseManager">-->
                        <!--</div>-->
                    <!--</div>-->
                    <!--<div class="form-group">-->
                        <!--<label for="departId" class="col-sm-3 control-label">领料部门</label>-->
                        <!--<div class="col-sm-9">-->
                            <!--<select name="" id="departIdPlan" class="form-control"></select>-->
                        <!--</div>-->
                    <!--</div>-->
                    <!--<div class="form-group">-->
                        <!--<label for="materialDw" class="col-sm-3 control-label">备注</label>-->
                        <!--<div class="col-sm-9">-->
                            <!--<input type="text" class="form-control" id="materialPlanUseRMK" >-->
                        <!--</div>-->
                    <!--</div>-->
                </form>
            </div>
            <div class="modal-footer">
                <!--<button type="button" class="btn btn-primary" id="subMaterialPlanUse">确定</button>-->
                <button type="button" class="btn btn-primary" id="subEditMaterialPlanUse">确定</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<script src="../../js/jquery-2.1.4.min.js"></script>
<script src="../../bootstrap/js/bootstrap.min.js"></script>
<script src="../../plugins/zTree/js/jquery.ztree.all.min.js"></script>
<scripT src="../../plugins/daterangepicker/moment.js"></scripT>
<script src="../../plugins/daterangepicker/daterangepicker.js"></script>
<script src="../../plugins/toastr/toastr.min.js"></script>
<script src="../../plugins/jquery/alert/js/xcConfirm.js"></script>
<script src="../../js/global.js"></script>
<script>
    (function ($) {
        //全局变量
        var date = new Date(),last,today,startTime,endTime,baseURL=window.global.SMXprogramURL, zNodes=[],protocols,MID='',BUID='';
        protocols={
            getMaterials:baseURL+'material/SHQMaterialGet',
            getUnit:baseURL+'buildunit/SHQBuildUnitGet',
            getMaterialUse:baseURL+'material/SHQMaterialUseGet',
            getMaterialIn:baseURL+'material/SHQMaterialInGet',
            addUseMaterial:baseURL +'material/SHQMaterialUseAdd',
            editUseMaterial:baseURL +'material/SHQMaterialUseEdit',
            delUseMaterial:baseURL +'material/SHQMaterialUseDel',
            addInMaterial:baseURL +'material/SHQMaterialInAdd',
            editInMaterial:baseURL +'material/SHQMaterialInEdit',
            delInMaterial:baseURL +'material/SHQMaterialInDel',
            getMaterialUse:baseURL+'material/SHQMaterialUseGet',
            getMaterialIn:baseURL+'material/SHQMaterialInGet',
            getDepart:baseURL +'safemodel/SHQDepartmentGet',
            editPlanUse:baseURL+'material/SHQMaterialPlanEdit',
        };
        today = date.getFullYear()+'-'+(date.getMonth()+1)+'-'+date.getDate();
        last = (date.getFullYear()-20)+'-'+(date.getMonth()+1)+'-'+date.getDate();
        startTime = today,
            endTime = today;
        var uName;
        var mainHeight = (window.innerHeight - 200)+'px';
        var tabHeight = (window.innerHeight - 150)+'px';
        $('.container,.mainContent').innerHeight(mainHeight);
//        $('.tab-pane').innerHeight(tabHeight);
        $(window).resize(function(){
            mainHeight = (window.innerHeight - 200)+'px';
            tabHeight = (window.innerHeight - 150)+'px';
            $('.container,.mainContent').innerHeight(mainHeight);
//            $('.tab-pane').innerHeight(tabHeight);
        });

        //初始化
        uName  = sessionStorage.getItem('PNAME');
        if(uName){
            $('#btnLogin').css('display','none');
            $('#loginOk').removeClass('ysh-disappear');
            $('#loginOk .xiUser').text(uName);
        }
        //配置datepicker
        $('#materialUseDate,#materialInDate,#materialPlanUseDate').daterangepicker({
            locale: {
                format : 'YYYY-MM-DD',
                separator: ' ~ ',
                weekLabel: '星期',
            },
            startDate:startTime,
            singleDatePicker:true,
            timePicker:true,
            timePicker24Hour:true
        });
        var setting = {
            data: {
                check:{
                    enable:true
                },
                key:{
                    name:'BUName'
                },
                simpleData: {
                    enable: true,
                    idKey:'BUNo',
                    pIdKey:'pId',
                    rootPId:null
                },
                view:{
                    showLine:true,
                    showIcon:true
                }
            },
            callback: {
                beforeMouseDown:beforeMouseDown,
                onMouseDown: onMouseDown,
            }
        };
        //渲染树
        $.ajax({
            url:protocols.getUnit,
            type:'get',
//            cache:'false',
            success:function (data) {
                if(!data.code){
                    //alert(data.msg);
                    zNodes = treeDataReconstruct(data.rows);

                    //console.log(d);
                }
                //渲染zTree
                $.fn.zTree.init($("#materialTreeUnit"), setting, zNodes);
            },
            error:function (data) {
                alert(data.msg)
            }
        });
        //渲染表格
        $.ajax({
            url:protocols.getMaterials,
            type:'post',
            cache:false,
            data:{
                ID:''
            },
            success:function (data) {
                if(!data.code){
                    $('#materialALLTable tbody').empty();
                    $('#materialPlanTable>tbody').empty();
                    $.each(data.rows,function (i,o) {
                        var t = '<tr data-mid="'+o.MID+'">' +
                            '<td>'+(i+1)+'</td><td class="MName">'+o.MName+'</td><td>'+o.Spec+'</td>' +
                            '<td>'+o.incount+'</td><td>'+o.usetotal+'</td>'+
                            '<td>'+(o.incount-o.usetotal)+'</td><td></td></tr>';
                        var t2 = '<tr data-mid="'+o.MID+'">' +
                                '<td>'+(i+1)+'</td><td class="MName">'+o.MName+'</td><td>'+o.Spec+'</td>' +
                                '<td>'+o.incount+'</td><td class="planUse">'+o.PlanCount+'</td>' +
                                '<td></td></tr>';
                        $('#materialPlanTable>tbody').append(t2);
                        $('#materialALLTable>tbody').append(t);
                        $('#materialALLTable>tbody td,#materialPlanTable>tbody td').unbind().on('click',function () {
                            $(this).parent().addClass('table-selected');
                            $(this).parent().siblings().removeClass('table-selected');
                            MID = $(this).parent().attr('data-mid');
//                            MName = $(this).siblings('.MName').text();
                        });
                    });
                }else{
                    alert(data.msg);
                }
            },
            error:function (data) {
                alert(data.msg);
            }
        });
        //绑定事件
        $('.ysh-menuList a').on('click',showList);
        $('.wsCont a').on('click',hideList);
        document.onclick = function(){
            $('.jdCont,.wsCont,.sysCont,.zlCont,.aqCont').addClass('ysh-disappear');
        }
        //进料
        $('.jlMaterial').on('click',jlMaterial);
        //领（用）料
        $('.ylMaterial').on('click',ylMaterial);
        //材料管理
        //用料
        $('.addUseMaterial').on('click',addUseMaterial);
        $('.editUseMaterial').on('click',editUseMaterial);
        $('.delUseMaterial').on('click',delUseMaterial);
        $('#subMaterialUse').on('click',subMaterialUse);
        $('#subEditMaterialUse').on('click',subEditMaterialUse);
        //进料
        $('.addInMaterial').on('click',addInMaterial);
        $('.editInMaterial').on('click',editInMaterial);
        $('.delInMaterial').on('click',delInMaterial);
        $('#subMaterialIn').on('click',subMaterialIn);
        $('#subEditMaterialIn').on('click',subEditMaterialIn);
        //修改计划用料
        $('.editPlanMaterial').on('click',editPlanBtn);
        $('#subEditMaterialPlanUse').on('click',editMaterialPlanUseBtn)
        //二级列表显示
        function showList(e) {
            window.event? window.event.cancelBubble = true : e.stopPropagation();
            if($(this).parent().has('ul')){
                $('.jdCont,.wsCont,.sysCont,.zlCont,.aqCont').addClass('ysh-disappear');
                $(this).siblings('ul').removeClass('ysh-disappear');
            }
        }
        function hideList(e) {
            window.event? window.event.cancelBubble = true : e.stopPropagation();
            $(this).parent().parent().addClass('ysh-disappear');

        }
        //鼠标点击之前
        function beforeMouseDown(treeId, treeNode) {
            if(!treeNode){
                return false;
            }else{
                return true;
            }
        }
        //鼠标点击
        function onMouseDown(event,treeId,treeNode) {
            console.log(treeNode);
            BUID = treeNode.BUID;
            buId = treeNode.BUID;
            var s =treeNode.BUName;
            var doc = $('.tableTitle');
            checkAllParents(treeNode,s,doc);
            //实际用料表格数据
            $.ajax({
                url:protocols.getMaterials,
                type:'post',
                cache:false,
                data:{
                    ID:treeNode.BUID,
//                    ID:''
                },
                success:function (data) {
                    if(!data.code){
                        console.log(data.rows)
                        if(data.rows.length){
                            $('#materialTable tbody').empty();
//                            $('#materialPlanTable>tbody').empty();
                            $.each(data.rows,function (i,o) {
                                var t = '<tr data-buid="'+buId+'" data-mid="'+o.MID+'">' +
                                        '<td>'+(i+1)+'</td><td class="MName">'+o.MName+'</td><td>'+o.Spec+'</td>' +
                                        '<td>'+o.usecount+'</td>' +
                                        '<td class="clKC">'+(o.incount-o.usetotal)+'</td><td></td></tr>';
                                $('#materialTable>tbody').append(t);
//                                var t2 = '<tr data-buid="'+buId+'" data-mid="'+o.MID+'">' +
//                                        '<td>'+(i+1)+'</td><td class="MName">'+o.MName+'</td><td>'+o.Model+'</td><td>'+o.Spec+'</td>' +
//                                        '<td class="planUse">'+o.incount+'</td><td>'+o.MUnit+'</td>' +
//                                        '<td>'+(o.incount-o.usecount)+'</td><td></td></tr>';
//                                $('#materialPlanTable>tbody').append(t2);
                                $('#materialTable>tbody td').unbind().on('click',function () {
                                    $(this).parent().addClass('table-selected');
                                    $(this).parent().siblings().removeClass('table-selected');
                                    MID = $(this).parent().attr('data-mid');
//                                MName = $(this).siblings('.MName').length;
//                                alert(MName);
                                });
                            });
                        }

                    }else{
                        alert(data.msg);
                    }
                },
                error:function (data) {
                    alert(data.msg);
                }
            });
            //alert(treeNode ? treeNode.BUID + ", " + treeNode.BUName : "isRoot");
            //计划材料数据
        }
        //treeDataReconstruct();修改左边树数据结构
        function treeDataReconstruct(data) {
            //alert('1')
            $.each(data,function (i,o) {
                if(o.BUNo.length < 3){
                    o.pId ='0'
                }else{
                    var s  = o.BUNo.slice(0,-3);
                    o.pId = s;
                }
            });
            return data;
        }
        //添加进料料模态框
        function jlMaterial() {
//            if(BUID && MID){
            if(MID){
//                alert(BUID);alert(MID)
                var MName = $('#materialALLTable>tbody>tr.table-selected>td.MName').text();
                console.log(MName)
                $.ajax({
                    url: protocols.getMaterialIn,
                    type: 'post',
                    data: {
//                        BUID: BUID,
                        MID: MID,
                    },
                    success: function (data) {
                        if (!data.code) {
//                            toastr.success(data.msg);
//                            $('#materialInTable').attr('data-buid', BUID);
                            $('#materialInTable').attr('data-mid', MID);
                            $('#materialInTable').attr('data-mname', MName);
                            $('#materialInTable>tbody').empty()
                            $.each(data.rows, function (i, o) {
                                var t = '<tr data-mInId="' + o.id + '">' +
                                    '<td>' + (i + 1) + '</td><td class="MName">' + MName + '</td><td>' + o.date + '</td><td>' + o.sum + '</td>' +
                                    '<td>'+o.conveyance+'</td><td>' + o.person + '</td><td>' + o.rmk + '</td></tr>';
                                $('#materialInTable>tbody').append(t);
                                $('#materialInTable>tbody>tr>td').unbind().on('click', function () {
                                    $(this).parent().addClass('table-selected');
                                    $(this).parent().siblings().removeClass('table-selected');
                                });
                            });
                            $('#materialInData').modal('show');
                        } else {
                            alert(data.msg)
                        }
                    },
                    error: function (data) {
                        alert(data.msg)
                    }
                });

            }else{
//                alert('请选择项目与材料');
                window.wxc.xcConfirm('请选择材料', window.wxc.xcConfirm.typeEnum.confirm);
            }
            $('#materialJLData').modal('show')
        }
        //用料
        function ylMaterial() {
            if(BUID && MID){
                var ck = $('#materialTable>tbody>tr.table-selected>td.clKC').text();
//                var usecont = $('#materialTable>tbody>tr.table-selected>td.usecount').text();
                var MName = $('#materialTable>tbody>tr.table-selected>td.MName').text();
                ck = parseInt(ck);
//                usecont = parseInt(usecont)

                if(ck){
//                    alert(BUID);alert(MID)

                    $.ajax({
                        url:protocols.getMaterialUse,
                        type:'post',
                        data:{
                            BUID:BUID,
                            MUSEID:MID,
                        },
                        success:function (data) {
                            if(!data.code){
//                            alert(data.msg);
                                console.log(data);
                                $('#materialUseTable').attr('data-MName',MName);
                                $('#materialUseTable').attr('data-buid', BUID);
                                $('#materialUseTable').attr('data-mid', MID);
                                $('#materialUseTable>tbody').empty()
                                $.each(data.rows,function (i,o) {
                                    var t  = '<tr data-mUseId="'+o.id+'">' +
                                            '<td>'+(i+1)+'</td><td class="MName">'+MName+'</td><td>'+o.date+'</td><td>'+o.sum+'</td>' +
                                            '<td>'+o.person+'</td><td>'+o.dpname+'</td><td>'+o.rmk+'</td></tr>';
                                    $('#materialUseTable>tbody').append(t);
                                    $('#materialUseTable>tbody>tr>td').unbind().on('click',function () {
                                        $(this).parent().addClass('table-selected');
                                        $(this).parent().siblings().removeClass('table-selected');
                                    });
                                });
                                $('#materialUseData').modal('show');
                                $('#materialUseTable').attr('data-buid',BUID);
                                $('#materialUseTable').attr('data-mid',MID);
                            }else{
                                alert(data.msg)
                            }
                        },
                        error:function (data) {
                            alert(data.msg)
                        }
                    });
                } else if(ck <= 0){
                    window.wxc.xcConfirm('当前'+MName+'材料库存不足', window.wxc.xcConfirm.typeEnum.warning);
                }else{
                    window.wxc.xcConfirm('请选择项目与材料', window.wxc.xcConfirm.typeEnum.confirm);
                }
//
            }else{
//                alert('请选择项目与材料');
                window.wxc.xcConfirm('请选择项目与材料', window.wxc.xcConfirm.typeEnum.confirm);
            }

        }
        //编辑材料模态框
        function editMaterial() {
            $('#materialModalLabel').text('修改材料信息');
            //$('#sgName').val('施工名称')
            $('#materialModal').modal('show')
        }
        //材料管理
        //用料
        function addUseMaterial() {
            var mName = $('#materialUseTable').attr('data-MName');
            $('#materialUseModal input').val('');
            $('.useMaterialForm').attr('data-buid',$('#materialUseTable').attr('data-buid'));
            $('.useMaterialForm').attr('data-mid',$('#materialUseTable').attr('data-mid'));
            $('.useMaterialForm').attr('data-MName',$('#materialUseTable').attr('data-MName'));
            $('#subMaterialUse').css('display','inline-block');
            $('#subEditMaterialUse').css('display','none');
            $('#materialUseModalLabel').text('新增'+mName+'领料');
            $('#materialUseModal').modal('show')
            $.ajax({
                url: protocols.getDepart,
                type: 'get',
                cache: false,
                data: {},
                success: function (data) {
                    if (!data.code) {
                        $('#depart').empty();
                        var o = '<option checked="checked" value="">请选择部门</option>';
                        $('#depart').append(o);

                        $.each(data.rows, function (i, o) {
                            var opt = '<option id="' + o.DPID + '" value="' + o.DPID + '">' + o.DPName + '</option>';
                            $('#departId').append(opt);

                        });
                        $('#materialUseModal').modal('show')
                    }
                },
                error: function (data) {
                    alert(data.msg)
                }
            });
        }
        function editUseMaterial() {
            var museid = $('#materialUseTable>tbody>tr.table-selected').attr('data-mUseId');
            var mName = $('#materialUseTable').attr('data-MName');
            $('#materialUseModal input').val('');
            // alert(museid);
            if(museid){
                $('.useMaterialForm').attr('data-buid',$('#materialUseTable').attr('data-buid'));
                $('.useMaterialForm').attr('data-mid',$('#materialUseTable').attr('data-mid'));
                $('.useMaterialForm').attr('data-MName',$('#materialUseTable').attr('data-MName'));
                $('#subMaterialUse').css('display','none');
                $('#subEditMaterialUse').css('display','inline-block');
                $('#materialUseModalLabel').text('编辑'+mName+'领料');
                var buid =$('#materialUseTable').attr('data-buid'),mid=$('#materialUseTable').attr('data-mid');
                $.ajax({
                    url: protocols.getDepart,
                    type: 'get',
                    cache: false,
                    data: {},
                    success: function (data) {
                        if (!data.code) {
                            $('#depart').empty();
                            var o = '<option checked="checked" value="">请选择部门</option>';
                            $('#depart').append(o);
                            $.each(data.rows, function (i, o) {
                                var opt = '<option id="' + o.DPID + '" value="' + o.DPID + '">' + o.DPName + '</option>';
                                $('#departId').append(opt);

                            });
                            $.ajax({
                                url:protocols.getMaterialUse,
                                type:'post',
                                data:{
                                    BUID:buid,
                                    MUSEID:mid
                                },
                                success:function (data) {
                                    if(!data.code){
                                        $.each(data.rows,function (i,o) {
                                            if(o.id == museid){
                                                $('#materialUseDate').val(o.date);
                                                $('#materialUseNum').val(o.sum);
                                                $('#materialUseManager').val(o.person);
                                                $('#materialUseRMK').val(o.rmk);
                                                var s  ='[value="'+o.dpname+'"]'
                                                $(s).attr('selected',true);
                                            }
                                        });
                                        $('#materialUseModal').modal('show')
                                    }
                                },
                                error:function (data) {
                                    alert(data.msg)
                                }
                            });
                        }
                    },
                    error: function (data) {
                        alert(data.msg)
                    }
                });

            }else{
//                alert('请先选择材料');
                window.wxc.xcConfirm('请选择材料', window.wxc.xcConfirm.typeEnum.confirm);
            }
        }
        function delUseMaterial() {
            var museid = $('#materialUseTable>tbody>tr.table-selected').attr('data-mUseId');
            if(museid){
                window.wxc.xcConfirm('确认删除该用料记录', window.wxc.xcConfirm.typeEnum.confirm,{
                    onOk:function () {
                        $.ajax({
                            url: protocols.delUseMaterial,
                            type: 'post',
                            data: {
                                MUSEID: museid
                            },
                            success: function (data) {
                                if (!data.code) {
                                    var buid = $('.useMaterialForm').attr('data-buid');
                                    var mid = $('.useMaterialForm').attr('data-mid');
                                    var MName = $('.useMaterialForm').attr('data-MName');
                                    $('#materialUseTable').attr('data-buid', buid);
                                    $('#materialUseTable').attr('data-mid', mid);
                                    $('#materialUseTable').attr('data-MName', MName);
                                    $.ajax({
                                        url: protocols.getMaterialUse,
                                        type: 'post',
                                        data: {
                                            BUID: $('.useMaterialForm').attr('data-buid'),
                                            MUSEID: $('.useMaterialForm').attr('data-mid'),
                                        },
                                        success: function (data) {
                                            if (!data.code) {
                                                $('#materialUseTable>tbody').empty();
                                                $.each(data.rows, function (i, o) {
//                                            if(o.id ==mUseId){
                                                    var t = '<tr data-mUseId="' + o.id + '">' +
                                                        '<td>' + (i + 1) + '</td class="MName"><td>' + MName + '</td><td>' + o.date + '</td><td>' + o.sum + '</td>' +
                                                        '<td>' + o.person + '</td><td>' + o.dpname + '</td><td>' + o.rmk + '</td></tr>';
                                                    $('#materialUseTable>tbody').append(t);
                                                    $('#materialUseTable>tbody>tr>td').unbind().on('click', function () {
                                                        $(this).parent().addClass('table-selected');
                                                        $(this).parent().siblings().removeClass('table-selected');
                                                    });
//                                            }

                                                });
                                                $('#materialUseModal').modal('hide');
                                            }
                                        },
                                        error: function (data) {
                                            alert(data.msg)
                                        }
                                    });
                                    drawTable();
                                } else {
                                    toastr.success(data.msg);
                                }
                            },
                            error: function (data) {
                                alert(data.msg)
                            },
                        });
                    }
                });
//                if(confirm("确认删除?")) {
//                    $.ajax({
//                        url: protocols.delUseMaterial,
//                        type: 'post',
//                        data: {
//                            MUSEID: museid
//                        },
//                        success: function (data) {
//                            if (!data.code) {
//                                var buid = $('.useMaterialForm').attr('data-buid');
//                                var mid = $('.useMaterialForm').attr('data-mid');
//                                var MName = $('.useMaterialForm').attr('data-MName');
//                                $('#materialUseTable').attr('data-buid', buid);
//                                $('#materialUseTable').attr('data-mid', mid);
//                                $('#materialUseTable').attr('data-MName', MName);
//                                $.ajax({
//                                    url: protocols.getMaterialUse,
//                                    type: 'post',
//                                    data: {
//                                        BUID: $('.useMaterialForm').attr('data-buid'),
//                                        MUSEID: $('.useMaterialForm').attr('data-mid'),
//                                    },
//                                    success: function (data) {
//                                        if (!data.code) {
//                                            $('#materialUseTable>tbody').empty();
//                                            $.each(data.rows, function (i, o) {
////                                            if(o.id ==mUseId){
//                                                var t = '<tr data-mUseId="' + o.id + '">' +
//                                                        '<td>' + (i + 1) + '</td class="MName"><td>' + MName + '</td><td>' + o.date + '</td><td>' + o.sum + '</td>' +
//                                                        '<td>' + o.person + '</td><td>' + o.dpname + '</td><td>' + o.rmk + '</td></tr>';
//                                                $('#materialUseTable>tbody').append(t);
//                                                $('#materialUseTable>tbody>tr>td').unbind().on('click', function () {
//                                                    $(this).parent().addClass('table-selected');
//                                                    $(this).parent().siblings().removeClass('table-selected');
//                                                });
////                                            }
//
//                                            });
//                                            $('#materialUseModal').modal('hide');
//                                        }
//                                    },
//                                    error: function (data) {
//                                        alert(data.msg)
//                                    }
//                                });
//                            } else {
//                                toastr.success(data.msg);
//                            }
//                        },
//                        error: function (data) {
//                            alert(data.msg)
//                        },
//                    });
//                }
            }else{
//                alert('请先选择材料');
                window.wxc.xcConfirm('请选择材料', window.wxc.xcConfirm.typeEnum.confirm);

            }
        }
        //新增材料用料
        function subMaterialUse() {
//            alert(  $('.useMaterialForm').attr('data-buid'));
//            alert(  $('.useMaterialForm').attr('data-mid'));

            var musid  = getUnitId();
            $.ajax({
                url:protocols.addUseMaterial,
                type:'post',
                data:{
                    MUSEID:musid,
                    BUID:$('.useMaterialForm').attr('data-buid'),
                    MID:$('.useMaterialForm').attr('data-mid'),
                    DATE:$('#materialUseDate').val(),
                    SUM:$('#materialUseNum').val(),
                    PERSON:$('#materialUseManager').val(),
                    REMARK:$('#materialUseRMK').val(),
                    DPID:$('#departId>option:selected').val(),
                },
                success:function (data) {

                    if(!data.code){
//                        toastr.success(data.msg);
                        var buid = $('.useMaterialForm').attr('data-buid');
                        var mid =$('.useMaterialForm').attr('data-mid');
                        var MName = $('.useMaterialForm').attr('data-MName');
                        $.ajax({
                            url:protocols.getMaterialUse,
                            type:'post',
                            data:{
                                BUID:$('.useMaterialForm').attr('data-buid'),
                                MUSEID:$('.useMaterialForm').attr('data-mid'),
                            },
                            success:function (data) {
                                if(!data.code){
                                    toastr.success(data.msg);
                                    $('#materialUseTable').attr('data-buid',buid);
                                    $('#materialUseTable').attr('data-mid',mid);
                                    $('#materialUseTable').attr('data-MName',MName);
                                    $('#materialUseTable>tbody').empty()
                                    $.each(data.rows,function (i,o) {
                                        var t  = '<tr data-mUseId="'+o.id+'">' +
                                            '<td>'+(i+1)+'</td><td class="MName">'+MName+'</td><td>'+o.date+'</td><td>'+o.sum+'</td>' +
                                            '<td>'+o.person+'</td><td>'+o.dpname+'</td><td>'+o.rmk+'</td></tr>';
                                        $('#materialUseTable>tbody').append(t);
                                        $('#materialUseTable>tbody>tr>td').unbind().on('click',function () {
                                            $(this).parent().addClass('table-selected');
                                            $(this).parent().siblings().removeClass('table-selected');
                                        });
                                    });
                                    $('#materialUseModal').modal('hide');
                                }else{
                                    alert(data.msg);
                                }
                            },
                            error:function (data) {
                                alert(data.msg);
                            }
                        });
                        drawTable();
                    }else{
                        alert(data.msg)
                    }
                },
                error:function (data) {
                    alert(data.msg)
                }
            });
        }
        //修改材料用料
        function subEditMaterialUse() {
            var mUseId = $('#materialUseTable>tbody>tr.table-selected').attr('data-mUseId');
            if(mUseId){
//                alert($('#departId>option:selected').val()
                $.ajax({
                    url:protocols.editUseMaterial,
                    type:'post',
                    data:{
                        MUSEID:mUseId,
                        BUID:$('.useMaterialForm').attr('data-buid'),
                        MID:$('.useMaterialForm').attr('data-mid'),
                        DATE:$('#materialUseDate').val(),
                        SUM:$('#materialUseNum').val(),
                        PERSON:$('#materialUseManager').val(),
                        REMARK:$('#materialUseRMK').val(),
                        DPID:$('#departId>option:selected').val(),
                    },
                    success:function(data){
                        if(!data.code){
//                            alert(data.msg);
                            var buid = $('.useMaterialForm').attr('data-buid');
//                            alert(buid);
                            var mid =$('.useMaterialForm').attr('data-mid');
                            var MName = $('.useMaterialForm').attr('data-MName');
                            $('#materialUseTable').attr('data-buid',buid);
                            $('#materialUseTable').attr('data-mid',mid);
                            $('#materialUseTable').attr('data-MName',MName);
                            $.ajax({
                                url:protocols.getMaterialUse,
                                type:'post',
                                data:{
                                    BUID:$('.useMaterialForm').attr('data-buid'),
                                    MUSEID:$('.useMaterialForm').attr('data-mid'),
                                },
                                success:function (data) {
                                    if(!data.code){
                                        toastr.success(data.msg);
                                        $('#materialUseTable>tbody').empty();
                                        $.each(data.rows,function (i,o) {
//                                            alert(1)
//                                            if(o.id == mUseId){
//                                                alert('1')
                                            var t  = '<tr data-mUseId="'+o.id+'">' +
                                                '<td>'+(i+1)+'</td class="MName"><td>'+MName+'</td><td>'+o.date+'</td><td>'+o.sum+'</td>' +
                                                '<td>'+o.person+'</td><td>'+o.dpname+'<td>'+o.rmk+'</td></tr>';
                                            $('#materialUseTable>tbody').append(t);

//                                            }

                                        });
                                        $('#materialUseTable>tbody>tr>td').unbind().on('click',function () {
                                            $(this).parent().addClass('table-selected');
                                            $(this).parent().siblings().removeClass('table-selected');
                                        });
                                        $('#materialUseModal').modal('hide');
                                    }
                                },
                                error:function (data) {
                                    alert(data.msg)
                                }
                            });
                            drawTable();
                        }else{
                            alert(data.msg)
                        }
                    },
                    error:function (data) {
                        alert(data.msg)
                    }
                })
            }else{
//                alert('请选择用料记录');
                window.wxc.xcConfirm('请选择用料记录', window.wxc.xcConfirm.typeEnum.confirm);
            }
        }
        //进料
        function addInMaterial() {
            var mName = $('#materialInTable').attr('data-mname');
            $('.inMaterialForm').attr('data-buid',$('#materialInTable').attr('data-buid'));
            $('.inMaterialForm').attr('data-mid',$('#materialInTable').attr('data-mid'));
            $('.inMaterialForm').attr('data-MName',$('#materialInTable').attr('data-MName'));
            $('#subMaterialIn').css('display','inline-block');
            $('#subEditMaterialIn').css('display','none');
            $('#materialInModalLabel').text('新增'+mName+'进料');
            $('#materialInModal input').val('')
            $('#materialInModal').modal('show')
        }
        function editInMaterial() {
            var minid = $('#materialInTable>tbody>tr.table-selected').attr('data-mInId');
            var mName = $('#materialInTable').attr('data-mname');
//            alert(minid);
            if(minid){
                $('.inMaterialForm').attr('data-buid',$('#materialInTable').attr('data-buid'));
                $('.inMaterialForm').attr('data-mid',$('#materialInTable').attr('data-mid'));
                $('.inMaterialForm').attr('data-MName',$('#materialInTable').attr('data-MName'));
                $('#subMaterialIn').css('display','none');
                $('#subEditMaterialIn').css('display','inline-block')
                $('#materialInModalLabel').text('编辑'+mName+'进料');
                var buid =$('#materialInTable').attr('data-buid'),mid=$('#materialInTable').attr('data-mid');
                $.ajax({
                    url:protocols.getMaterialIn,
                    type:'post',
                    data:{
                        BUID:buid,
                        MID:mid
                    },
                    success:function (data) {
                        if(!data.code){
                            $.each(data.rows,function (i,o) {
                                if(o.id == minid){
                                    $('#materialInDate').val(o.date);
                                    $('#materialInSum').val(o.sum);
                                    $('#materialInTool').val(o.conveyance);
                                    $('#materialInManager').val(o.person);
                                    $('#materialInRMK').val(o.rmk);
                                }
                            });
                            $('#materialInModal').modal('show')
                        }
                    },
                    error:function (data) {
                        alert(data.msg)
                    }
                });

            }else{
//                alert('请先选择材料');
                window.wxc.xcConfirm('请选择材料', window.wxc.xcConfirm.typeEnum.confirm);

            }

        }
        function delInMaterial() {
            var minid = $('#materialInTable>tbody>tr.table-selected').attr('data-mInId');
//            alert(minid);
            if(minid){
                window.wxc.xcConfirm('确认删除该进料记录', window.wxc.xcConfirm.typeEnum.confirm,{
                  onOk:function () {
                      $.ajax({
                          url: protocols.delInMaterial,
                          type: 'post',
                          data: {
                              MINID: minid
                          },
                          success: function (data) {
                              if (!data.code) {

//                            alert(data.msg)
                                  var buid = $('.inMaterialForm').attr('data-buid');
                                  var mid = $('.inMaterialForm').attr('data-mid');
                                  var MName = $('.inMaterialForm').attr('data-MName');
                                  $('#materialInTable').attr('data-buid', buid);
                                  $('#materialInTable').attr('data-mid', mid);
                                  $('#materialInTable').attr('data-MName', MName);
                                  $.ajax({
                                      url: protocols.getMaterialIn,
                                      type: 'post',
                                      data: {
                                          BUID: $('.inMaterialForm').attr('data-buid'),
                                          MID: $('.inMaterialForm').attr('data-mid'),
                                      },
                                      success: function (data) {
                                          if (!data.code) {
                                              toastr.success(data.msg);
                                              $('#materialInTable>tbody').empty();
                                              $.each(data.rows, function (i, o) {
                                                  console.log(minid);
                                                  console.log(o.id);
                                                  if (o.id == minid) {
                                                      var t = '<tr data-mInId="' + o.id + '">' +
                                                          '<td>' + (i + 1) + '</td class="MName"><td>' + MName + '</td><td>' + o.date + '</td><td>' + o.sum + '</td>' +
                                                          '<td>' + o.person + '</td><td></td><td>' + o.rmk + '</td></tr>';
                                                      $('#materialInTable>tbody').append(t);
                                                      $('#materialInTable>tbody>tr>td').unbind().on('click', function () {
                                                          $(this).parent().addClass('table-selected');
                                                          $(this).parent().siblings().removeClass('table-selected');
                                                      });
                                                  }
                                              });
//
                                              $('#materialInModal').modal('hide');
                                          }
                                      },
                                      error: function (data) {
                                          alert(data.msg)
                                      }
                                  });
                                  drawTable();
                              } else {
                                  alert(data.msg)
                              }
                          },
                          error: function (data) {
                              alert(data.msg)
                          },
                      });
                  }
                });

//                if(confirm("确认删除?")) {
//                    $.ajax({
//                        url: protocols.delInMaterial,
//                        type: 'post',
//                        data: {
//                            MINID: minid
//                        },
//                        success: function (data) {
//                            if (!data.code) {
////                            alert(data.msg)
//                                var buid = $('.inMaterialForm').attr('data-buid');
//                                var mid = $('.inMaterialForm').attr('data-mid');
//                                var MName = $('.inMaterialForm').attr('data-MName');
//                                $('#materialInTable').attr('data-buid', buid);
//                                $('#materialInTable').attr('data-mid', mid);
//                                $('#materialInTable').attr('data-MName', MName);
//                                $.ajax({
//                                    url: protocols.getMaterialIn,
//                                    type: 'post',
//                                    data: {
//                                        BUID: $('.inMaterialForm').attr('data-buid'),
//                                        MID: $('.inMaterialForm').attr('data-mid'),
//                                    },
//                                    success: function (data) {
//                                        if (!data.code) {
//                                            toastr.success(data.msg);
//                                            $('#materialInTable>tbody').empty();
//                                            $.each(data.rows, function (i, o) {
//                                                console.log(minid);
//                                                console.log(o.id);
//                                                if (o.id == minid) {
//                                                    var t = '<tr data-mInId="' + o.id + '">' +
//                                                            '<td>' + (i + 1) + '</td class="MName"><td>' + MName + '</td><td>' + o.date + '</td><td>' + o.sum + '</td>' +
//                                                            '<td>' + o.person + '</td><td></td><td>' + o.rmk + '</td></tr>';
//                                                    $('#materialInTable>tbody').append(t);
//                                                    $('#materialInTable>tbody>tr>td').unbind().on('click', function () {
//                                                        $(this).parent().addClass('table-selected');
//                                                        $(this).parent().siblings().removeClass('table-selected');
//                                                    });
//                                                }
//                                            });
////
//                                            $('#materialInModal').modal('hide');
//                                        }
//                                    },
//                                    error: function (data) {
//                                        alert(data.msg)
//                                    }
//                                });
//                            } else {
//                                alert(data.msg)
//                            }
//                        },
//                        error: function (data) {
//                            alert(data.msg)
//                        },
//                    });
//                }
            }else{
//                alert('请先选择材料');
                window.wxc.xcConfirm('请选择材料', window.wxc.xcConfirm.typeEnum.confirm);
            }
        }
        //新增材料进料
        function subMaterialIn() {
//            alert(  $('.inMaterialForm').attr('data-buid'));
//            alert(  $('.inMaterialForm').attr('data-mid'));
            var miniId = getUnitId();
            $.ajax({
                url:protocols.addInMaterial,
                type:'post',
                data:{
                    MINID:miniId,
                    BUID:$('.inMaterialForm').attr('data-buid'),
                    MID:$('.inMaterialForm').attr('data-mid'),
                    DATE:$('#materialInDate').val(),
                    SUM:$('#materialInSum').val(),
                    CONVEYANCE:$('#materialInTool').val(),
                    PERSON:$('#materialInManager').val(),
                    REMARK:$('#materialInRMK').val(),
                },
                success:function (data) {
                    if(!data.code){
                        var buid = $('.inMaterialForm').attr('data-buid');
                        var mId = $('.inMaterialForm').attr('data-mid');
                        var MName  = $('.inMaterialForm').attr('data-MName');
                        $.ajax({
                            url:protocols.getMaterialIn,
                            type:'post',
                            data:{
                                BUID:$('.inMaterialForm').attr('data-buid'),
                                MID:$('.inMaterialForm').attr('data-mid'),
                            },
                            success:function (data) {
                                if(!data.code){
                                    toastr.success(data.msg);
                                    $('#materialInTable').attr('data-buid',buid);
                                    $('#materialInTable').attr('data-mid',mId);
                                    $('#materialInTable').attr('data-MName',MName);
                                    $('#materialInTable>tbody').empty();
                                    $.each(data.rows,function (i,o) {
                                        var t  = '<tr data-mInId="'+o.id+'">' +
                                            '<td>'+(i+1)+'</td><td class="MName">'+MName+'</td><td>'+o.date+'</td><td>'+o.sum+'</td>' +
                                            '<td>'+o.conveyance+'</td><td>'+o.person+'</td><td>'+o.rmk+'</td></tr>';
                                        $('#materialInTable>tbody').append(t);
                                        $('#materialInTable>tbody>tr>td').unbind().on('click',function () {
                                            $(this).parent().addClass('table-selected');
                                            $(this).parent().siblings().removeClass('table-selected');
                                        });
                                    });
                                    drawTable();
//                                    window.location.reload();
                                    $('#materialInModal').modal('hide');
//                                    $('#materialInData').modal('hide')
                                }else{
                                    alert(data.msg)
                                }
                            },
                            error:function (data) {
                                alert(data.msg)
                            }
                        });
                    }else{
                        alert(data.msg)
                    }
                },
                error:function (data) {
                    alert(data.msg)
                }
            });
        };
        //修改材料进料
        function subEditMaterialIn() {
            var minid = $('#materialInTable>tbody>tr.table-selected').attr('data-mInId');
            var MName = $('#materialInTable>tbody>tr.table-selected>td.MName').text();
            $.ajax({
                url:protocols.editInMaterial,
                type:'post',
                data:{
                    MINID:minid,
                    BUID:$('.inMaterialForm').attr('data-buid'),
                    MID:$('.inMaterialForm').attr('data-mid'),
                    DATE:$('#materialInDate').val(),
                    SUM:$('#materialInSum').val(),
                    CONVEYANCE:$('#materialInTool').val(),
                    PERSON:$('#materialInManager').val(),
                    REMARK:$('#materialInRMK').val(),
                },
                success:function (data) {
                    if(!data.code){
                        var buid = $('.inMaterialForm').attr('data-buid');
                        var mId = $('.inMaterialForm').attr('data-mid');
                        var MName  = $('.inMaterialForm').attr('data-MName');
                        $.ajax({
                            url:protocols.getMaterialIn,
                            type:'post',
                            data:{
                                BUID:$('.inMaterialForm').attr('data-buid'),
                                MID:$('.inMaterialForm').attr('data-mid'),
                            },
                            success:function (data) {
                                if(!data.code){
//                                    alert(data.msg);
                                    $('#materialInTable').attr('data-buid',buid);
                                    $('#materialInTable').attr('data-mid',mId);
                                    $('#materialInTable').attr('data-MName',MName);
                                    $.ajax({
                                        url:protocols.getMaterialIn,
                                        type:'post',
                                        data:{
                                            BUID:$('.inMaterialForm').attr('data-buid'),
                                            MID:$('.inMaterialForm').attr('data-mid'),
                                        },
                                        success:function (data) {
                                            if(!data.code){
                                                toastr.success(data.msg);
                                                $('#materialInTable>tbody').empty();
                                                $.each(data.rows,function (i,o) {
                                                    console.log(minid);
                                                    console.log(o.id);
//                                                    if(o.id ==minid){
                                                        var t  = '<tr data-mInId="'+o.id+'">' +
                                                            '<td>'+(i+1)+'</td class="MName"><td>'+MName+'</td><td>'+o.date+'</td><td>'+o.sum+'</td>' +
                                                            '<td>'+o.conveyance+'</td><td>'+o.person+'</td><td>'+o.rmk+'</td></tr>';
                                                        $('#materialInTable>tbody').append(t);
                                                        $('#materialInTable>tbody>tr>td').unbind().on('click',function () {
                                                            $(this).parent().addClass('table-selected');
                                                            $(this).parent().siblings().removeClass('table-selected');
                                                        });
//                                                    }

                                                });
//                                                window.location.reload();
                                                $('#materialInModal').modal('hide');
//                                                $('#materialInModal').modal('hide')
                                            }
                                        },
                                        error:function (data) {
                                            alert(data.msg)
                                        }
                                    });

                                }else{
                                    alert(data.msg)
                                }
                            },
                            error:function (data) {
                                alert(data.msg)
                            }
                        });
                        drawTable();
                    }else{
                        alert(data.msg)
                    }
                }
            })
        }
        //修改计划用料
        function editPlanBtn() {
            var mId = $('#materialPlanTable>tbody>tr.table-selected').attr('data-mid');
            var mName  = $('#materialPlanTable>tbody>tr.table-selected>td.mName').text();
            var planUse = $('#materialPlanTable>tbody>tr.table-selected>td.planUse').text();
            if(mId){
                $('#materialPlanUseModal').attr('data-mid',mId);
                $('.useMaterialForm').attr('data-mid',mId);
                $('#materialPlanUseModalLabel').text('修改'+mName+'计划用料');
                $('#materialPlanUseNum').val(planUse);
                $.ajax({
                    url: protocols.getDepart,
                    type: 'get',
                    cache: false,
                    data: {},
                    success: function (data) {
                        if (!data.code) {

                            $('#departIdPlan').empty();
                            var o = '<option checked="checked" value="">请选择部门</option>';
                            $('#depart').append(o);

                            $.each(data.rows, function (i, o) {
                                var opt = '<option id="' + o.DPID + '" value="' + o.DPID + '">' + o.DPName + '</option>';
                                $('#departIdPlan').append(opt);

                            });
//                            $('#materialUseModal').modal('show')
                            $('#materialPlanUseModal').modal('show')
                        }
                    },
                    error: function (data) {
//                        alert(data.msg)
                        window.wxc.xcConfirm(data.msg, window.wxc.xcConfirm.typeEnum.warning);
                    }
                });

            }else{
                window.wxc.xcConfirm('请选择材料', window.wxc.xcConfirm.typeEnum.warning);
            }
        }
        function editMaterialPlanUseBtn() {
            $.ajax({
                url:protocols.editPlanUse,
                type:'post',
                data:{
                    MID: $('.useMaterialForm').attr('data-mid'),
                    PLANCOUNT:$('#materialPlanUseNum').val(),
                },
                success:function (data) {
                    if(!data.code){
                        $.ajax({
                            url:protocols.getMaterials,
                            type:'post',
                            cache:false,
                            data:{
                                ID:''
                            },
                            success:function (data) {
                                if(!data.code){
                                    toastr.success(data.msg);
                                    $('#materialPlanTable>tbody').empty();
                                    $.each(data.rows,function (i,o) {

                                        var t2 = '<tr data-mid="'+o.MID+'">' +
                                                '<td>'+(i+1)+'</td><td class="MName">'+o.MName+'</td><td>'+o.Spec+'</td>' +
                                                '<td>'+o.incount+'</td><td class="planUse">'+o.PlanCount+'</td>' +
                                                '<td></td></tr>';
                                        $('#materialPlanTable>tbody').append(t2);
                                        $('#materialPlanTable>tbody td').unbind().on('click',function () {
                                            $(this).parent().addClass('table-selected');
                                            $(this).parent().siblings().removeClass('table-selected');
                                            MID = $(this).parent().attr('data-mid');
//                            MName = $(this).siblings('.MName').text();
                                        });
                                    });
                                    $('#materialPlanUseModal').modal('hide')
                                }else{
                                    alert(data.msg);
                                }
                            },
                            error:function (data) {
                                alert(data.msg);
                            }
                        });
                    }else{
                        window.wxc.xcConfirm(data.msg, window.wxc.xcConfirm.typeEnum.warning);
                    }
                }
            })
        }
        function checkAllParents(treeNode,string,doc) {
            if (!treeNode.pId) {
                doc.text(string);
                return string;

            } else {
                treeNode.checked = true;
                string = treeNode.getParentNode().BUName + "-" + string;
                checkAllParents(treeNode.getParentNode(), string, doc);
            }
        }

        function drawTable() {
            //渲染表格
            $.ajax({
                url:protocols.getMaterials,
                type:'post',
                cache:false,
                data:{
                    ID:''
                },
                success:function (data) {
                    if(!data.code){
                        $('#materialALLTable tbody').empty();
                        $('#materialPlanTable>tbody').empty();
                        $.each(data.rows,function (i,o) {
                            var t = '<tr data-mid="'+o.MID+'">' +
                                    '<td>'+(i+1)+'</td><td class="MName">'+o.MName+'</td><td>'+o.Spec+'</td>' +
                                    '<td>'+o.incount+'</td><td>'+o.usetotal+'</td>'+
                                    '<td>'+(o.incount-o.usetotal)+'</td><td></td></tr>';
                            var t2 = '<tr data-mid="'+o.MID+'">' +
                                    '<td>'+(i+1)+'</td><td class="MName">'+o.MName+'</td><td>'+o.Spec+'</td>' +
                                    '<td>'+o.incount+'</td><td class="planUse">'+o.PlanCount+'</td>' +
                                    '<td></td></tr>';
                            $('#materialPlanTable>tbody').append(t2);
                            $('#materialALLTable>tbody').append(t);
                            $('#materialALLTable>tbody td,#materialPlanTable>tbody td').unbind().on('click',function () {
                                $(this).parent().addClass('table-selected');
                                $(this).parent().siblings().removeClass('table-selected');
                                MID = $(this).parent().attr('data-mid');
//                            MName = $(this).siblings('.MName').text();
                            });
                        });
                    }else{
                        alert(data.msg);
                    }
                },
                error:function (data) {
                    alert(data.msg);
                }
            });
        }
        //32Id随机值
        function getUnitId() {
            var chars = ['0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];
            var res = "";
            for(var i = 0; i < 32 ; i ++) {
                var id = Math.ceil(Math.random()*35);
                res += chars[id];
            }
            return res;

        }
    })(window.jQuery)
</script>
</body>
</html>